#!/usr/bin/env node
var debug = require('debug')('explorer');
var settings = require('../lib/settings');
var db = require('../lib/database');
var app = require('../app');

app.set('port', process.env.PORT || settings.port);

Promise.all(settings.coin.map(i=>{
  var dbString = 'mongodb://' + settings.dbsettings.user;
  dbString = dbString + ':' + settings.dbsettings.password;
  dbString = dbString + '@' + settings.dbsettings.address;
  dbString = dbString + ':' + settings.dbsettings.port;
  dbString = dbString + '/' + i.coin;
  db.connect(dbString).then(() =>{
    // console.log('???')
    db.check_stats(i.coin).then((exists) =>{
      // console.log(settings.coin)
      if (exists == false) {
        console.log('no stats entry found, creating now..');
        db.create_stats(i.coin).then(()=>{
          //console.log('stats entry created successfully.');
        });
      } else {

      }
    });
    db.check_richlist(i.coin).then((exists)=>{
      if (exists == false) {
        console.log('no richlist entry found, creating now..');
        db.create_richlist(i.coin).then(() =>{});
      }
    });
  });
})).then(()=>{
  app.listen(app.get('port'), function() {
    debug('Express server listening on port ' + settings.port);
  });
})

